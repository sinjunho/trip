<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.trip.model.dao.PlanBoardDao">

    <!-- ======================== ResultMap ì •ì˜ ======================== -->
    
    <!-- PlanBoard ResultMap -->
    <resultMap id="planBoardResultMap" type="com.ssafy.trip.model.dto.PlanBoard">
        <id property="pboardNo" column="pboard_no" />
        <result property="title" column="title" />
        <result property="content" column="content" />
        <result property="writer" column="writer" />
        <result property="userId" column="user_id" />
        <result property="regDate" column="reg_date" />
        <result property="updateDate" column="update_date" />
        <result property="viewCnt" column="view_cnt" />
        <result property="planId" column="plan_id" />
        <result property="travelTitle" column="travel_title" />
        <result property="startDate" column="start_date" />
        <result property="endDate" column="end_date" />
        <result property="travelDestinations" column="travel_destinations" />
        <result property="travelTheme" column="travel_theme" />
        <result property="estimatedBudget" column="estimated_budget" />
        <result property="participantCount" column="participant_count" />
        <result property="travelDuration" column="travel_duration" />
        <result property="isPublic" column="is_public" />
        <result property="isFeatured" column="is_featured" />
        <result property="likeCount" column="like_count" />
        <result property="commentCount" column="comment_count" />
        <result property="thumbnailImage" column="thumbnail_image" />
        <result property="attachmentFiles" column="attachment_files" />
    </resultMap>
    
    <!-- PlanBoardSummary ResultMap -->
    <resultMap id="planBoardSummaryResultMap" type="com.ssafy.trip.model.dto.PlanBoardSummary">
        <id property="pboardNo" column="pboard_no" />
        <result property="title" column="title" />
        <result property="writer" column="writer" />
        <result property="userId" column="user_id" />
        <result property="regDate" column="reg_date" />
        <result property="viewCnt" column="view_cnt" />
        <result property="likeCount" column="like_count" />
        <result property="commentCount" column="comment_count" />
        <result property="travelTitle" column="travel_title" />
        <result property="startDate" column="start_date" />
        <result property="endDate" column="end_date" />
        <result property="travelDestinations" column="travel_destinations" />
        <result property="travelTheme" column="travel_theme" />
        <result property="estimatedBudget" column="estimated_budget" />
        <result property="participantCount" column="participant_count" />
        <result property="travelDuration" column="travel_duration" />
        <result property="thumbnailImage" column="thumbnail_image" />
        <result property="isFeatured" column="is_featured" />
        <result property="isLiked" column="is_liked" />
        <result property="tagNames" column="tag_names" />
    </resultMap>
    
    <!-- PlanBoardComment ResultMap -->
    <resultMap id="planBoardCommentResultMap" type="com.ssafy.trip.model.dto.PlanBoardComment">
        <id property="commentId" column="comment_id" />
        <result property="pboardNo" column="pboard_no" />
        <result property="userId" column="user_id" />
        <result property="writer" column="writer" />
        <result property="content" column="content" />
        <result property="parentCommentId" column="parent_comment_id" />
        <result property="regDate" column="reg_date" />
        <result property="updateDate" column="update_date" />
        <result property="isDeleted" column="is_deleted" />
        <result property="replyCount" column="reply_count" />
    </resultMap>
    
    <!-- PlanBoardTag ResultMap -->
    <resultMap id="planBoardTagResultMap" type="com.ssafy.trip.model.dto.PlanBoardTag">
        <id property="tagId" column="tag_id" />
        <result property="tagName" column="tag_name" />
        <result property="useCount" column="use_count" />
        <result property="createdAt" column="created_at" />
    </resultMap>
    
    <!-- PlanBoardLike ResultMap -->
    <resultMap id="planBoardLikeResultMap" type="com.ssafy.trip.model.dto.PlanBoardLike">
        <id property="likeId" column="like_id" />
        <result property="pboardNo" column="pboard_no" />
        <result property="userId" column="user_id" />
        <result property="createdAt" column="created_at" />
    </resultMap>

    <!-- ======================== ê²Œì‹œê¸€ CRUD ======================== -->
    
   <!-- ê¸°ì¡´ insertPlanBoard ì¿¼ë¦¬ ìˆ˜ì • -->
<insert id="insertPlanBoard" parameterType="com.ssafy.trip.model.dto.PlanBoard" useGeneratedKeys="true" keyProperty="pboardNo">
    INSERT INTO plan_board (
        title, content, writer, user_id, plan_id, travel_title, start_date, end_date,
        travel_destinations, travel_theme, estimated_budget, participant_count, travel_duration,
        is_public, is_featured, thumbnail_image, attachment_files
    ) VALUES (
        #{title}, #{content}, #{writer}, #{userId}, #{planId}, #{travelTitle}, #{startDate}, #{endDate},
        #{travelDestinations}, #{travelTheme}, #{estimatedBudget}, #{participantCount}, #{travelDuration},
        <!-- ðŸ”¥ Booleanì„ ì •ìˆ˜ë¡œ ëª…ì‹œì  ë³€í™˜ -->
        CASE WHEN #{isPublic} = true THEN 1 ELSE 0 END, 
        CASE WHEN #{isFeatured} = true THEN 1 ELSE 0 END, 
        #{thumbnailImage}, #{attachmentFiles}
    )
</insert>
    
   <!-- ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ (ìš”ì•½ ì •ë³´) - ìˆ˜ì •ëœ ë²„ì „ -->
<select id="selectPlanBoardList" parameterType="com.ssafy.trip.model.dto.PlanBoardSearchCondition" resultMap="planBoardSummaryResultMap">
    SELECT 
        pb.pboard_no, pb.title, pb.writer, pb.user_id, pb.reg_date, pb.view_cnt, 
        pb.like_count, pb.comment_count, pb.travel_title, pb.start_date, pb.end_date,
        pb.travel_destinations, pb.travel_theme, pb.estimated_budget, pb.participant_count,
        pb.travel_duration, pb.thumbnail_image, pb.is_featured, pb.is_public,
        CASE 
            WHEN #{userId} IS NOT NULL AND pbl.user_id IS NOT NULL THEN TRUE 
            ELSE FALSE 
        END as is_liked,
        GROUP_CONCAT(pbt.tag_name ORDER BY pbt.tag_name SEPARATOR ',') as tag_names
    FROM plan_board pb
    LEFT JOIN plan_board_like pbl ON pb.pboard_no = pbl.pboard_no AND pbl.user_id = #{userId}
    LEFT JOIN plan_board_tag_relation pbtr ON pb.pboard_no = pbtr.pboard_no
    LEFT JOIN plan_board_tag pbt ON pbtr.tag_id = pbt.tag_id
    WHERE 1=1
    <!-- ê³µê°œ ê²Œì‹œê¸€ ë˜ëŠ” ë‚´ê°€ ìž‘ì„±í•œ ê²Œì‹œê¸€ë§Œ ì¡°íšŒ -->
    <choose>
        <when test="onlyMyPosts == true and userId != null">
            AND pb.user_id = #{userId}
        </when>
        <otherwise>
            AND (pb.is_public = TRUE 
                 <if test="userId != null">
                     OR pb.user_id = #{userId}
                 </if>
                )
        </otherwise>
    </choose>
    
    <if test="key != null and word != null and word != ''">
        <choose>
            <when test="key == 'title'">
                AND pb.title LIKE CONCAT('%', #{word}, '%')
            </when>
            <when test="key == 'content'">
                AND pb.content LIKE CONCAT('%', #{word}, '%')
            </when>
            <when test="key == 'writer'">
                AND pb.writer LIKE CONCAT('%', #{word}, '%')
            </when>
            <when test="key == 'all'">
                AND (pb.title LIKE CONCAT('%', #{word}, '%') 
                     OR pb.content LIKE CONCAT('%', #{word}, '%') 
                     OR pb.writer LIKE CONCAT('%', #{word}, '%'))
            </when>
        </choose>
    </if>
    <if test="travelTheme != null and travelTheme != ''">
        AND pb.travel_theme = #{travelTheme}
    </if>
    <if test="destination != null and destination != ''">
        AND pb.travel_destinations LIKE CONCAT('%', #{destination}, '%')
    </if>
    <if test="startDateFrom != null">
        AND pb.start_date >= #{startDateFrom}
    </if>
    <if test="startDateTo != null">
        <![CDATA[
        AND pb.start_date <= #{startDateTo}
        ]]>
    </if>
    <if test="budgetMin != null">
        <![CDATA[
        AND pb.estimated_budget >= #{budgetMin}
        ]]>
    </if>
    <if test="budgetMax != null">
        <![CDATA[
        AND pb.estimated_budget <= #{budgetMax}
        ]]>
    </if>
    <if test="participantCount != null">
        AND pb.participant_count = #{participantCount}
    </if>
    <if test="onlyFeatured">
        AND pb.is_featured = TRUE
    </if>
    <if test="tagName != null and tagName != ''">
        AND pb.pboard_no IN (
            SELECT pbtr2.pboard_no 
            FROM plan_board_tag_relation pbtr2 
            JOIN plan_board_tag pbt2 ON pbtr2.tag_id = pbt2.tag_id 
            WHERE pbt2.tag_name = #{tagName}
        )
    </if>
    GROUP BY pb.pboard_no
    <choose>
        <when test="sortBy == 'popular'">
            ORDER BY pb.view_cnt DESC, pb.reg_date DESC
        </when>
        <when test="sortBy == 'likes'">
            ORDER BY pb.like_count DESC, pb.reg_date DESC
        </when>
        <otherwise>
            ORDER BY pb.reg_date DESC
        </otherwise>
    </choose>
    LIMIT #{offset}, #{itemsPerPage}
</select>
    
    <!-- ê²Œì‹œê¸€ ìƒì„¸ ì¡°íšŒ -->
    <select id="selectPlanBoardDetail" resultMap="planBoardResultMap">
        SELECT * FROM plan_board WHERE pboard_no = #{pboardNo}
    </select>
    
<!-- updatePlanBoard ì¿¼ë¦¬ë„ ë™ì¼í•˜ê²Œ ìˆ˜ì • -->
<update id="updatePlanBoard" parameterType="com.ssafy.trip.model.dto.PlanBoard">
    UPDATE plan_board SET
        title = #{title},
        content = #{content},
        travel_title = #{travelTitle},
        start_date = #{startDate},
        end_date = #{endDate},
        travel_destinations = #{travelDestinations},
        travel_theme = #{travelTheme},
        estimated_budget = #{estimatedBudget},
        participant_count = #{participantCount},
        travel_duration = #{travelDuration},
        <!-- ðŸ”¥ Booleanì„ ì •ìˆ˜ë¡œ ëª…ì‹œì  ë³€í™˜ -->
        is_public = CASE WHEN #{isPublic} = true THEN 1 ELSE 0 END,
        is_featured = CASE WHEN #{isFeatured} = true THEN 1 ELSE 0 END,
        thumbnail_image = #{thumbnailImage},
        attachment_files = #{attachmentFiles},
        update_date = CURRENT_TIMESTAMP
    WHERE pboard_no = #{pboardNo}
</update>
    
    <!-- ê²Œì‹œê¸€ ì‚­ì œ -->
    <delete id="deletePlanBoard">
        DELETE FROM plan_board WHERE pboard_no = #{pboardNo}
    </delete>
    
    <!-- ì¡°íšŒìˆ˜ ì¦ê°€ -->
    <update id="updateViewCount">
        UPDATE plan_board SET view_cnt = view_cnt + 1 WHERE pboard_no = #{pboardNo}
    </update>
    
    
<!-- ì „ì²´ ê²Œì‹œê¸€ ìˆ˜ ì¡°íšŒ - ìˆ˜ì •ëœ ë²„ì „ -->
<select id="getTotalPlanBoardCount" parameterType="com.ssafy.trip.model.dto.PlanBoardSearchCondition" resultType="int">
    SELECT COUNT(DISTINCT pb.pboard_no)
    FROM plan_board pb
    LEFT JOIN plan_board_tag_relation pbtr ON pb.pboard_no = pbtr.pboard_no
    LEFT JOIN plan_board_tag pbt ON pbtr.tag_id = pbt.tag_id
    WHERE 1=1
    <!-- ê³µê°œ ê²Œì‹œê¸€ ë˜ëŠ” ë‚´ê°€ ìž‘ì„±í•œ ê²Œì‹œê¸€ë§Œ ì¡°íšŒ -->
    <choose>
        <when test="onlyMyPosts == true and userId != null">
            AND pb.user_id = #{userId}
        </when>
        <otherwise>
            AND (pb.is_public = TRUE 
                 <if test="userId != null">
                     OR pb.user_id = #{userId}
                 </if>
                )
        </otherwise>
    </choose>
    
    <if test="key != null and word != null and word != ''">
        <choose>
            <when test="key == 'title'">
                AND pb.title LIKE CONCAT('%', #{word}, '%')
            </when>
            <when test="key == 'content'">
                AND pb.content LIKE CONCAT('%', #{word}, '%')
            </when>
            <when test="key == 'writer'">
                AND pb.writer LIKE CONCAT('%', #{word}, '%')
            </when>
            <when test="key == 'all'">
                AND (pb.title LIKE CONCAT('%', #{word}, '%') 
                     OR pb.content LIKE CONCAT('%', #{word}, '%') 
                     OR pb.writer LIKE CONCAT('%', #{word}, '%'))
            </when>
        </choose>
    </if>
    <if test="travelTheme != null and travelTheme != ''">
        AND pb.travel_theme = #{travelTheme}
    </if>
    <if test="destination != null and destination != ''">
        AND pb.travel_destinations LIKE CONCAT('%', #{destination}, '%')
    </if>
    <if test="startDateFrom != null">
        AND pb.start_date >= #{startDateFrom}
    </if>
    <if test="startDateTo != null">
        <![CDATA[
        AND pb.start_date <= #{startDateTo}
        ]]>
    </if>
    <if test="budgetMin != null">
        <![CDATA[
        AND pb.estimated_budget >= #{budgetMin}
        ]]>
    </if>
    <if test="budgetMax != null">
        <![CDATA[
        AND pb.estimated_budget <= #{budgetMax}
        ]]>
    </if>
    <if test="participantCount != null">
        AND pb.participant_count = #{participantCount}
    </if>
    <if test="onlyFeatured">
        AND pb.is_featured = TRUE
    </if>
    <if test="tagName != null and tagName != ''">
        AND pb.pboard_no IN (
            SELECT pbtr2.pboard_no 
            FROM plan_board_tag_relation pbtr2 
            JOIN plan_board_tag pbt2 ON pbtr2.tag_id = pbt2.tag_id 
            WHERE pbt2.tag_name = #{tagName}
        )
    </if>
</select>
    
    <!-- ì¶”ì²œ ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ -->
    <select id="selectFeaturedPlanBoards" resultMap="planBoardSummaryResultMap">
        SELECT 
            pb.pboard_no, pb.title, pb.writer, pb.user_id, pb.reg_date, pb.view_cnt, 
            pb.like_count, pb.comment_count, pb.travel_title, pb.start_date, pb.end_date,
            pb.travel_destinations, pb.travel_theme, pb.estimated_budget, pb.participant_count,
            pb.travel_duration, pb.thumbnail_image, pb.is_featured,
            FALSE as is_liked,
            GROUP_CONCAT(pbt.tag_name ORDER BY pbt.tag_name SEPARATOR ',') as tag_names
        FROM plan_board pb
        LEFT JOIN plan_board_tag_relation pbtr ON pb.pboard_no = pbtr.pboard_no
        LEFT JOIN plan_board_tag pbt ON pbtr.tag_id = pbt.tag_id
        WHERE pb.is_featured = TRUE AND pb.is_public = TRUE
        GROUP BY pb.pboard_no
        ORDER BY pb.reg_date DESC
        LIMIT #{limit}
    </select>
    
    <!-- ì¸ê¸° ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ (ì¢‹ì•„ìš” ìˆœ) -->
    <select id="selectPopularPlanBoards" resultMap="planBoardSummaryResultMap">
        SELECT 
            pb.pboard_no, pb.title, pb.writer, pb.user_id, pb.reg_date, pb.view_cnt, 
            pb.like_count, pb.comment_count, pb.travel_title, pb.start_date, pb.end_date,
            pb.travel_destinations, pb.travel_theme, pb.estimated_budget, pb.participant_count,
            pb.travel_duration, pb.thumbnail_image, pb.is_featured,
            FALSE as is_liked,
            GROUP_CONCAT(pbt.tag_name ORDER BY pbt.tag_name SEPARATOR ',') as tag_names
        FROM plan_board pb
        LEFT JOIN plan_board_tag_relation pbtr ON pb.pboard_no = pbtr.pboard_no
        LEFT JOIN plan_board_tag pbt ON pbtr.tag_id = pbt.tag_id
        WHERE pb.is_public = TRUE
        GROUP BY pb.pboard_no
        ORDER BY pb.like_count DESC, pb.view_cnt DESC, pb.reg_date DESC
        LIMIT #{limit}
    </select>
    
    <!-- ì‚¬ìš©ìžë³„ ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ -->
    <select id="selectPlanBoardsByUserId" resultMap="planBoardSummaryResultMap">
        SELECT 
            pb.pboard_no, pb.title, pb.writer, pb.user_id, pb.reg_date, pb.view_cnt, 
            pb.like_count, pb.comment_count, pb.travel_title, pb.start_date, pb.end_date,
            pb.travel_destinations, pb.travel_theme, pb.estimated_budget, pb.participant_count,
            pb.travel_duration, pb.thumbnail_image, pb.is_featured,
            FALSE as is_liked,
            GROUP_CONCAT(pbt.tag_name ORDER BY pbt.tag_name SEPARATOR ',') as tag_names
        FROM plan_board pb
        LEFT JOIN plan_board_tag_relation pbtr ON pb.pboard_no = pbtr.pboard_no
        LEFT JOIN plan_board_tag pbt ON pbtr.tag_id = pbt.tag_id
        WHERE pb.user_id = #{userId}
        GROUP BY pb.pboard_no
        ORDER BY pb.reg_date DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- ======================== ëŒ“ê¸€ CRUD ======================== -->
    
    <!-- ëŒ“ê¸€ ë“±ë¡ -->
    <insert id="insertComment" parameterType="com.ssafy.trip.model.dto.PlanBoardComment" useGeneratedKeys="true" keyProperty="commentId">
        INSERT INTO plan_board_comment (pboard_no, user_id, writer, content, parent_comment_id)
        VALUES (#{pboardNo}, #{userId}, #{writer}, #{content}, #{parentCommentId})
    </insert>
    
    <!-- ê²Œì‹œê¸€ë³„ ëŒ“ê¸€ ëª©ë¡ ì¡°íšŒ -->
    <select id="selectCommentsByPboardNo" resultMap="planBoardCommentResultMap">
        SELECT 
            pbc.*,
            (SELECT COUNT(*) FROM plan_board_comment 
             WHERE parent_comment_id = pbc.comment_id AND is_deleted = FALSE) as reply_count
        FROM plan_board_comment pbc
        WHERE pbc.pboard_no = #{pboardNo} AND pbc.parent_comment_id IS NULL AND pbc.is_deleted = FALSE
        ORDER BY pbc.reg_date ASC
    </select>
    
    <!-- ëŒ“ê¸€ ìˆ˜ì • -->
    <update id="updateComment" parameterType="com.ssafy.trip.model.dto.PlanBoardComment">
        UPDATE plan_board_comment SET
            content = #{content},
            update_date = CURRENT_TIMESTAMP
        WHERE comment_id = #{commentId}
    </update>
    
    <!-- ëŒ“ê¸€ ì‚­ì œ (soft delete) -->
    <update id="deleteComment">
        UPDATE plan_board_comment SET
            is_deleted = TRUE,
            update_date = CURRENT_TIMESTAMP
        WHERE comment_id = #{commentId}
    </update>
    
    <!-- ëŒ€ëŒ“ê¸€ ëª©ë¡ ì¡°íšŒ -->
    <select id="selectRepliesByParentId" resultMap="planBoardCommentResultMap">
        SELECT * FROM plan_board_comment
        WHERE parent_comment_id = #{parentCommentId} AND is_deleted = FALSE
        ORDER BY reg_date ASC
    </select>

    <!-- ======================== ì¢‹ì•„ìš” ê´€ë¦¬ ======================== -->
    
    <!-- ì¢‹ì•„ìš” ì¶”ê°€ -->
    <insert id="insertLike" parameterType="com.ssafy.trip.model.dto.PlanBoardLike">
        INSERT INTO plan_board_like (pboard_no, user_id) VALUES (#{pboardNo}, #{userId})
    </insert>
    
    <!-- ì¢‹ì•„ìš” ì‚­ì œ -->
    <delete id="deleteLike">
        DELETE FROM plan_board_like WHERE pboard_no = #{pboardNo} AND user_id = #{userId}
    </delete>
    
    <!-- ì¢‹ì•„ìš” ì—¬ë¶€ í™•ì¸ -->
    <select id="isLikedByUser" resultType="boolean">
        <![CDATA[
        SELECT COUNT(*) > 0 FROM plan_board_like 
        WHERE pboard_no = #{pboardNo} AND user_id = #{userId}
        ]]>
    </select>
    
    <!-- ê²Œì‹œê¸€ë³„ ì¢‹ì•„ìš” ëª©ë¡ ì¡°íšŒ -->
    <select id="selectLikesByPboardNo" resultMap="planBoardLikeResultMap">
        SELECT * FROM plan_board_like WHERE pboard_no = #{pboardNo} ORDER BY created_at DESC
    </select>

    <!-- ======================== íƒœê·¸ ê´€ë¦¬ ======================== -->
    
    <!-- íƒœê·¸ ë“±ë¡ -->
    <insert id="insertTag" parameterType="com.ssafy.trip.model.dto.PlanBoardTag" useGeneratedKeys="true" keyProperty="tagId">
        INSERT INTO plan_board_tag (tag_name) VALUES (#{tagName})
    </insert>
    
    <!-- íƒœê·¸ëª…ìœ¼ë¡œ íƒœê·¸ ì¡°íšŒ -->
    <select id="selectTagByName" resultMap="planBoardTagResultMap">
        SELECT * FROM plan_board_tag WHERE tag_name = #{tagName}
    </select>
    
    <!-- ì¸ê¸° íƒœê·¸ ëª©ë¡ ì¡°íšŒ -->
    <select id="selectPopularTags" resultMap="planBoardTagResultMap">
        SELECT * FROM plan_board_tag ORDER BY use_count DESC LIMIT #{limit}
    </select>
    
    <!-- ê²Œì‹œê¸€-íƒœê·¸ ì—°ê²° -->
    <insert id="insertTagRelation" parameterType="com.ssafy.trip.model.dto.PlanBoardTagRelation">
        INSERT INTO plan_board_tag_relation (pboard_no, tag_id) VALUES (#{pboardNo}, #{tagId})
    </insert>
    
    <!-- ê²Œì‹œê¸€-íƒœê·¸ ì—°ê²° í•´ì œ -->
    <delete id="deleteTagRelation">
        DELETE FROM plan_board_tag_relation WHERE pboard_no = #{pboardNo} AND tag_id = #{tagId}
    </delete>
    
    <!-- ê²Œì‹œê¸€ì˜ ëª¨ë“  íƒœê·¸ ì—°ê²° í•´ì œ -->
    <delete id="deleteAllTagRelations">
        DELETE FROM plan_board_tag_relation WHERE pboard_no = #{pboardNo}
    </delete>
    
    <!-- ê²Œì‹œê¸€ë³„ íƒœê·¸ ëª©ë¡ ì¡°íšŒ -->
    <select id="selectTagsByPboardNo" resultMap="planBoardTagResultMap">
        SELECT pbt.* FROM plan_board_tag pbt
        JOIN plan_board_tag_relation pbtr ON pbt.tag_id = pbtr.tag_id
        WHERE pbtr.pboard_no = #{pboardNo}
        ORDER BY pbt.tag_name
    </select>
    
    <!-- íƒœê·¸ë³„ ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ -->
    <select id="selectPlanBoardsByTag" resultMap="planBoardSummaryResultMap">
        SELECT 
            pb.pboard_no, pb.title, pb.writer, pb.user_id, pb.reg_date, pb.view_cnt, 
            pb.like_count, pb.comment_count, pb.travel_title, pb.start_date, pb.end_date,
            pb.travel_destinations, pb.travel_theme, pb.estimated_budget, pb.participant_count,
            pb.travel_duration, pb.thumbnail_image, pb.is_featured,
            FALSE as is_liked,
            GROUP_CONCAT(pbt2.tag_name ORDER BY pbt2.tag_name SEPARATOR ',') as tag_names
        FROM plan_board pb
        JOIN plan_board_tag_relation pbtr ON pb.pboard_no = pbtr.pboard_no
        JOIN plan_board_tag pbt ON pbtr.tag_id = pbt.tag_id
        LEFT JOIN plan_board_tag_relation pbtr2 ON pb.pboard_no = pbtr2.pboard_no
        LEFT JOIN plan_board_tag pbt2 ON pbtr2.tag_id = pbt2.tag_id
        WHERE pbt.tag_name = #{tagName} AND pb.is_public = TRUE
        GROUP BY pb.pboard_no
        ORDER BY pb.reg_date DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- ======================== í†µê³„ ë° ê¸°íƒ€ ======================== -->
    
    <!-- ì—¬í–‰ í…Œë§ˆë³„ í†µê³„ -->
    <select id="selectTravelThemeStatistics" resultType="java.util.HashMap">
        SELECT 
            travel_theme as theme,
            COUNT(*) as count,
            AVG(estimated_budget) as avgBudget,
            AVG(travel_duration) as avgDuration
        FROM plan_board 
        WHERE travel_theme IS NOT NULL AND is_public = TRUE
        GROUP BY travel_theme
        ORDER BY count DESC
    </select>
    
    <!-- ì›”ë³„ ê²Œì‹œê¸€ í†µê³„ -->
    <select id="selectMonthlyStatistics" resultType="java.util.HashMap">
        SELECT 
            MONTH(reg_date) as month,
            COUNT(*) as count,
            AVG(view_cnt) as avgViews,
            AVG(like_count) as avgLikes
        FROM plan_board 
        WHERE YEAR(reg_date) = #{year} AND is_public = TRUE
        GROUP BY MONTH(reg_date)
        ORDER BY month
    </select>
    
    <!-- ì „ì²´ ê²Œì‹œê¸€ ìˆ˜ ì¡°íšŒ -->
    <select id="getTotalPlanBoardCountAll" resultType="int">
        SELECT COUNT(*) FROM plan_board WHERE is_public = TRUE
    </select>
    
    <!-- ê²Œì‹œê¸€ ê²€ìƒ‰ -->
    <select id="searchPlanBoards" resultMap="planBoardSummaryResultMap">
        SELECT 
            pb.pboard_no, pb.title, pb.writer, pb.user_id, pb.reg_date, pb.view_cnt, 
            pb.like_count, pb.comment_count, pb.travel_title, pb.start_date, pb.end_date,
            pb.travel_destinations, pb.travel_theme, pb.estimated_budget, pb.participant_count,
            pb.travel_duration, pb.thumbnail_image, pb.is_featured,
            FALSE as is_liked,
            GROUP_CONCAT(pbt.tag_name ORDER BY pbt.tag_name SEPARATOR ',') as tag_names
        FROM plan_board pb
        LEFT JOIN plan_board_tag_relation pbtr ON pb.pboard_no = pbtr.pboard_no
        LEFT JOIN plan_board_tag pbt ON pbtr.tag_id = pbt.tag_id
        WHERE pb.is_public = TRUE
        <choose>
            <when test="searchType == 'title'">
                AND pb.title LIKE CONCAT('%', #{keyword}, '%')
            </when>
            <when test="searchType == 'content'">
                AND pb.content LIKE CONCAT('%', #{keyword}, '%')
            </when>
            <when test="searchType == 'writer'">
                AND pb.writer LIKE CONCAT('%', #{keyword}, '%')
            </when>
            <when test="searchType == 'destination'">
                AND pb.travel_destinations LIKE CONCAT('%', #{keyword}, '%')
            </when>
            <otherwise>
                AND (pb.title LIKE CONCAT('%', #{keyword}, '%') 
                     OR pb.content LIKE CONCAT('%', #{keyword}, '%') 
                     OR pb.writer LIKE CONCAT('%', #{keyword}, '%')
                     OR pb.travel_destinations LIKE CONCAT('%', #{keyword}, '%'))
            </otherwise>
        </choose>
        GROUP BY pb.pboard_no
        ORDER BY pb.reg_date DESC
        LIMIT #{offset}, #{limit}
    </select>
    
    <!-- ê²€ìƒ‰ ê²°ê³¼ ìˆ˜ ì¡°íšŒ -->
    <select id="getSearchResultCount" resultType="int">
        SELECT COUNT(DISTINCT pb.pboard_no)
        FROM plan_board pb
        WHERE pb.is_public = TRUE
        <choose>
            <when test="searchType == 'title'">
                AND pb.title LIKE CONCAT('%', #{keyword}, '%')
            </when>
            <when test="searchType == 'content'">
                AND pb.content LIKE CONCAT('%', #{keyword}, '%')
            </when>
            <when test="searchType == 'writer'">
                AND pb.writer LIKE CONCAT('%', #{keyword}, '%')
            </when>
            <when test="searchType == 'destination'">
                AND pb.travel_destinations LIKE CONCAT('%', #{keyword}, '%')
            </when>
            <otherwise>
                AND (pb.title LIKE CONCAT('%', #{keyword}, '%') 
                     OR pb.content LIKE CONCAT('%', #{keyword}, '%') 
                     OR pb.writer LIKE CONCAT('%', #{keyword}, '%')
                     OR pb.travel_destinations LIKE CONCAT('%', #{keyword}, '%'))
            </otherwise>
        </choose>
    </select>

</mapper>